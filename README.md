[åˆé›† \- èŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™!(10\)](https://github.com)[1\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! Â· åºã€‹çµæ„Ÿæ¥æº07\-30](https://github.com/wlovet/p/18333053)[2\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬ä¸€ç¯‡â€”ä¹°äº‘æœåŠ¡å™¨å’Œåˆå§‹åŒ–ç¯å¢ƒ08\-05](https://github.com/wlovet/p/18336522)[3\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬äºŒç¯‡â€”åç«¯åº”ç”¨æ­å»ºå’Œå®Œæˆç¬¬ä¸€ä¸ªçˆ¬è™«08\-12](https://github.com/wlovet/p/18350862)[4\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬ä¸‰ç¯‡â€”çƒ­æœè¡¨ç»“æ„è®¾è®¡å’Œçƒ­æœæ•°æ®å­˜å‚¨08\-19](https://github.com/wlovet/p/18367044)[5\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬å››ç¯‡â€”å‰ç«¯åº”ç”¨æ­å»ºå’Œå®Œæˆç¬¬ä¸€ä¸ªçƒ­æœç»„ä»¶08\-26](https://github.com/wlovet/p/18376100)[6\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬äº”ç¯‡â€”é€šè¿‡xxl\-jobå®šæ—¶è·å–çƒ­æœæ•°æ®09\-02](https://github.com/wlovet/p/18392182)[7\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬å…­ç¯‡â€”å°†å°ç½‘ç«™éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ä¸Š09\-09](https://github.com/wlovet/p/18403018)[8\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬ä¸ƒç¯‡â€”è°è®¿é—®äº†æˆ‘ä»¬çš„ç½‘ç«™ï¼Ÿ10\-09](https://github.com/wlovet/p/18454074)[9\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬å…«ç¯‡â€”å¢åŠ è¯äº‘ç»„ä»¶å’Œæœç´¢ç»„ä»¶10\-22](https://github.com/wlovet/p/18492618)10\.ã€ŠèŠ±100å—åšä¸ªæ‘¸é±¼å°ç½‘ç«™! ã€‹ç¬¬ä¹ç¯‡â€”æˆ‘çš„å°ç½‘ç«™è¢«æ”»å‡»äº†ï¼11\-22æ”¶èµ·
> **ç›®å½•**
> 
> [ä¸€ã€å‰è¨€](#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80)[äºŒã€è¢«æ”»å‡»çš„è¿‡ç¨‹](#%E4%BA%8C%E3%80%81%E8%A2%AB%E6%94%BB%E5%87%BB%E7%9A%84%E8%BF%87%E7%A8%8B):[è“çŒ«æœºåœº](https://fenfang.org)[ä¸‰ã€å°ç½‘ç«™çš„ç»Ÿè®¡è§„åˆ™](#%E4%B8%89%E3%80%81%E5%B0%8F%E7%BD%91%E7%AB%99%E7%9A%84%E7%BB%9F%E8%AE%A1%E8%A7%84%E5%88%99)[å››ã€é™æµå¤§æ³•å¥½](#%E5%9B%9B%E3%80%81%E9%99%90%E6%B5%81%E5%A4%A7%E6%B3%95%E5%A5%BD)[1ã€æ»‘åŠ¨çª—å£é™æµ](#1%E3%80%81%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E9%99%90%E6%B5%81)[2ã€åŸç†è¯´æ˜](#2%E3%80%81%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E)[3ã€ä»£ç å®ç°](#3%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0)[äº”ã€å°ç»“ä¸€ä¸‹](#%E4%BA%94%E3%80%81%E5%B0%8F%E7%BB%93%E4%B8%80%E4%B8%8B)



> â­ï¸åŸºç¡€é“¾æ¥å¯¼èˆªâ­ï¸
> 
> 
> æœåŠ¡å™¨ â†’ [â˜ï¸ é˜¿é‡Œäº‘æ´»åŠ¨åœ°å€](https://github.com)
> 
> 
> çœ‹æ ·ä¾‹ â†’ [ğŸŸ æ‘¸é±¼å°ç½‘ç«™åœ°å€](https://github.com)
> 
> 
> å­¦ä»£ç  â†’ [ğŸ’» æºç åº“åœ°å€](https://github.com)


# ä¸€ã€å‰è¨€


å¤§å®¶å¥½å‘€ï¼Œæˆ‘æ˜¯summoï¼Œæœ€è¿‘ä¸æ˜¯è¢«è£å‘˜äº†å˜›ï¼Œæ‰¾å·¥ä½œåˆéš¾æ‰¾ï¼Œè€æ˜¯å¿ƒçƒ¦æ„ä¹±çš„ï¼Œä¹Ÿå¯¼è‡´äº†ä¸€ä¸ªå¤šæœˆæ–­æ›´ï¼Œä¸å¥½æ„æ€å“ˆã€‚è™½ç„¶å·¥ä½œæ²¡äº†ï¼Œä½†æ˜¯å°ç½‘ç«™çš„æ•…äº‹å´ä¸€ç›´åœ¨å‘ç”Ÿï¼Œæ¯”å¦‚é˜¿é‡Œäº‘RDSåˆ°æœŸå¯¼è‡´æˆ‘çš„å°ç½‘ç«™å´©äº†ä¸€ä¸ªæœˆï¼ˆå·²ç»ä¿®å¤ï¼‰ï¼›æ¯”å¦‚æˆ‘é‡æ„äº†ä¸€ä¸‹è®¾è®¡å’Œä»£ç ï¼ˆä»£ç å·²ä¸Šä¼ Giteeï¼‰ï¼›æ¯”å¦‚æœ‰äº›â€œå¥½å¿ƒäººâ€åˆ·æˆ‘çš„æ¥å£ï¼Œç»™æˆ‘æé«˜è®¿é—®é‡ï¼ˆæœ¬ç¯‡ä¼šè®²çš„æ•…äº‹ï¼‰... ...


è¿˜æœ‰ä¸€äº›æ›´æœ‰æ„æ€çš„ï¼Œæ¯”å¦‚æµå—æœ‰ä½è€æ¿çœ‹ä¸­äº†æˆ‘çš„å°ç½‘ç«™å¸Œæœ›æˆ‘å¯ä»¥æ ¹æ®ä»–çš„ä¸€äº›éœ€æ±‚è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼ˆä¸€æœŸå·²ç»åšå¥½ä¸Šçº¿äº†ï¼‰ï¼›æ¯”å¦‚é€šè¿‡è¿™ä¸ªå°ç½‘ç«™è®©æˆ‘èµšåˆ°1åƒå¤šçš„å¤–å¿«ï¼ˆæ„å¤–ä¹‹å–œï¼‰ç­‰ç­‰ã€‚


å·¥ä½œæ˜¯ä¸€æ—¶çš„ï¼Œå…´è¶£æ˜¯ä¸€è¾ˆå­çš„ï¼Œæ— è®ºå¦‚ä½•ï¼Œä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä¼šç»§ç»­æ›´æ–°å°ç½‘ç«™çš„æ•…äº‹ï¼Œè¿™ä¸€ç¯‡ä¸»é¢˜ï¼šæˆ‘çš„å°ç½‘ç«™è¢«æ”»å‡»äº†ï¼


# äºŒã€è¢«æ”»å‡»çš„è¿‡ç¨‹


åœ¨æˆ‘å°ç½‘ç«™çš„å³ä¾§æœ‰ä¸€å—è®¿é—®ç»Ÿè®¡çš„å±•ç¤ºï¼Œæ˜¾ç¤ºç€ä»Šæ—¥PVï¼Œä»Šå¤©UVã€æ€»PVå’Œæ€»UVï¼ˆPVï¼šé¡µé¢æµè§ˆé‡ï¼Œè®¿é—®ä¸€æ¬¡æˆ‘åŠ ä¸€æ¬¡ï¼›UVï¼šç‹¬ç«‹è®¿å®¢æ•°ï¼Œä¸€ä¸ªIPæˆ‘ç®—ä¸€ä¸ªï¼‰ï¼Œå¦‚ä¸‹å›¾ï¼š
![](https://img2024.cnblogs.com/blog/1127399/202411/1127399-20241122145915760-1436334970.png)



> è¿™æ˜¯2024\-11\-22æˆªçš„å›¾ï¼Œæ€»UVæ‰2Wå¤šï¼Œä½†æ˜¯PVå·²ç»8Wå¤šäº†ï¼Œç›¸å½“äºæ¯ä¸ªç”¨æˆ·å¹³å‡è®¿é—®äº†å°ç½‘ç«™4æ¬¡ï¼Œè™½ç„¶çœ‹èµ·æ¥ä¹Ÿä¸ç®—å¾ˆç¦»è°±ï¼Œä½†å®é™…ä¸Šæœ‰å‡ ä¸ªâ€œå¥½å¿ƒäººâ€å•ç‹¬å°±è´¡çŒ®äº†1\.5Wæ¬¡çš„è®¿é—®ï¼Œå¦‚ä¸‹å›¾ï¼š
> ![](https://img2024.cnblogs.com/blog/1127399/202411/1127399-20241122150450976-983285836.png)
> è‡³äºä»–ä»¬ä¸ºä»€ä¹ˆæ”»å‡»æˆ‘ï¼Œè·Ÿæˆ‘ä¹Ÿæ˜¯æœ‰å¾ˆå¤§å…³ç³»ï¼Œæˆ‘æ›¾ç»åœ¨åšå®¢å›­çš„é—ªå­˜â€œå¤§æ”¾å¥è¯â€ï¼š
> ![](https://img2024.cnblogs.com/blog/1127399/202411/1127399-20241122142933628-939264247.png)


# ä¸‰ã€å°ç½‘ç«™çš„ç»Ÿè®¡è§„åˆ™


ä¹‹å‰æˆ‘ä»¬åœ¨[ç¬¬ä¸ƒç¯‡â€”è°è®¿é—®äº†æˆ‘ä»¬çš„ç½‘ç«™ï¼Ÿ](https://github.com)ä¸­ä»‹ç»äº†å°ç½‘ç«™çš„ç»Ÿè®¡é€»è¾‘ï¼Œæ ¸å¿ƒé€»è¾‘å°±æ˜¯åŠ äº†ä¸€ä¸ª`@VisitLog`æ³¨è§£ï¼Œä½¿ç”¨åˆ‡é¢çš„æ–¹å¼è®°å½•è®¿é—®çš„IPåœ°å€ã€‚ç„¶åå°†è¿™ä¸ªæ³¨è§£æ”¾åœ¨äº†`IndexController.java`çš„indexæ–¹æ³•ä¸Šï¼Œå¦‚ä¸‹ï¼š



```
@Controller
public class IndexController {

    @GetMapping("/")
    @VisitLog
    public String index(HttpServletRequest request) {
        if (isFromMobile(request)) {
            return "mp/index";
        } else {
            return "web/index";
        }
    }
}

```


> ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä½ ä»¬ç–¯ç‹‚è°ƒç”¨https://sbmy.funï¼Œå°±ä¼šä¸æ–­åœ°å¢åŠ è®¿é—®è®°å½•ã€‚æ­£å¦‚æˆ‘å‰é¢æ‰€è¯´çš„æˆ‘å¹¶æ²¡æœ‰ä½¿ç”¨CDNã€OSSè¿™ç§æŒ‰æŒ‰æµé‡è®¡è´¹çš„ç»„ä»¶ï¼Œæ— è®ºä½ ä»¬æ€ä¹ˆåˆ·éƒ½æ˜¯ä¸ä¼šç»™æˆ‘é€ æˆèµ„æŸçš„ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜æˆ‘ä¸å¾—ä¸å¤„ç†ä¸€ä¸‹ï¼š
> å‰ç«¯çš„èµ„æºæ¥è‡ªäºæˆ‘çš„åº”ç”¨ï¼Œèµ„æºåŒ…æ‹¬jsã€cssã€å›¾ç‰‡ã€å­—ä½“ç­‰æ–‡ä»¶ï¼Œè¿™äº›èµ„æºè¿˜éƒ½ä¸å°ï¼Œå°¤å…¶æ˜¯chunk\-vendors.jsï¼Œä½“ç§¯è¾¾åˆ°äº†1\.2Mï¼Œå¦‚ä¸‹å›¾ï¼š
> ![](https://img2024.cnblogs.com/blog/1127399/202411/1127399-20241122153506046-207371313.png)
> é˜¿é‡Œäº‘çš„ECSå…¬ç½‘IPå¸¦å®½é»˜è®¤åªæœ‰3Mï¼Œä¹Ÿå°±æ˜¯è¯´å°ç½‘ç«™åŒæ—¶æœ‰ä¸‰ä¸ªäººè®¿é—®å°±ä¼šå‡ºç°è®¿é—®æ•ˆç‡é—®é¢˜ï¼Œé—®é¢˜å…¶å®ä¹Ÿä¸å¤§ï¼Œæµè§ˆå™¨åªè¦è®¿é—®ä¸€æ¬¡è¿™äº›èµ„æºå°±ä¼šå°†å®ƒä»¬ç¼“å­˜ä¸‹æ¥ï¼Œåç»­å†åˆ·æ–°ä¹Ÿä¸ä¼šå¾ˆæ…¢ã€‚ä½†æ˜¯å¦‚æœè¢«æ”»å‡»äº†å‘¢ï¼Œé‚£å°±éº»çƒ¦äº†ï¼Œæ­£å¸¸ç”¨æˆ·æƒ³è®¿é—®éƒ½ä¸è¡Œäº†... ... æ‰€ä»¥æˆ‘å¿…é¡»å¾—æƒ³ä¸ªæ³•å­äº†ã€‚


# å››ã€é™æµå¤§æ³•å¥½


åƒæˆ‘ä»¬è¿™ç§å°ç½‘ç«™ï¼Œæµé‡ä¹Ÿä¸å¤§ï¼Œè¢«æ”»å‡»äº†å¥½åƒä¹Ÿæ²¡å•¥æ„ä¹‰ï¼Œæœ‰äº›æ”»å‡»çº¯ç²¹å°±æ˜¯å…„å¼Ÿä»¬å¼€çš„ç©ç¬‘ï¼Œæç€ç©çš„ã€‚ä½†æ—¢ç„¶å…„å¼Ÿä»¬å‡ºæ‹›äº†ï¼Œæˆ‘è¿™è¾¹ä¹Ÿå¾—æƒ³ä¸ªæ³•å­è§£å†³ä¸æ˜¯ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œæä¸ªæ»‘åŠ¨çª—å£é™æµå°±å¯ä»¥äº†ã€‚



> æˆ‘å…ˆè®²ä¸€ä¸‹ä»€ä¹ˆæ˜¯é™æµï¼Œç‹è€…è£è€€å¤§å®¶éƒ½ç©è¿‡å§ï¼Œé‡Œé¢çš„è‹±é›„éƒ½æœ‰ä¸€ä¸ªæ”»å‡»é—´éš”ï¼Œå½“æˆ‘ä»¬è¿ç»­çš„ç‚¹å‡»æ™®é€šæ”»å‡»çš„æ—¶å€™ï¼Œè‹±é›„çš„æ”»é€Ÿå¹¶ä¸ä¼šéšç€æˆ‘ä»¬ç‚¹å‡»çš„è¶Šå¿«è€Œæ›´å¿«çš„æ”»å‡»ã€‚è¿™ä¸ªå°±æ˜¯é™æµï¼Œè‹±é›„ä¼šæŒ‰ç…§è‡ªèº«æ”»é€Ÿçš„ç³»æ•°æ‰§è¡Œæ”»å‡»ï¼Œæˆ‘ä»¬ç‚¹çš„å†å¿«ä¹Ÿæ²¡ç”¨ã€‚


## 1ã€æ»‘åŠ¨çª—å£é™æµ


å…ˆä¸Šä¸€å¼ æµç¨‹å›¾ï¼Œå¸®åŠ©å¤§å®¶ç†è§£åŸç†
![](https://img2024.cnblogs.com/blog/1127399/202411/1127399-20241122154815469-146239414.png)


## 2ã€åŸç†è¯´æ˜


![](https://img2024.cnblogs.com/blog/1127399/202401/1127399-20240110190301568-1554061615.png)



> ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°æ—¶é—´åˆ›å»ºæ˜¯ä¸€ç§æ»‘åŠ¨çš„æ–¹å¼å‰è¿›ï¼Œ æ»‘åŠ¨çª—å£é™æµç­–ç•¥èƒ½å¤Ÿæ˜¾è‘—å‡å°‘ä¸´ç•Œé—®é¢˜çš„å½±å“ï¼Œä½†å¹¶ä¸èƒ½å®Œå…¨æ¶ˆé™¤å®ƒã€‚æ»‘åŠ¨çª—å£é€šè¿‡è·Ÿè¸ªå’Œé™åˆ¶åœ¨ä¸€ä¸ªè¿ç»­çš„æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ¥å·¥ä½œã€‚ä¸ç®€å•çš„è®¡æ•°å™¨æ–¹æ³•ä¸åŒï¼Œå®ƒä¸æ˜¯åœ¨çª—å£ç»“æŸæ—¶çªç„¶é‡ç½®è®¡æ•°å™¨ï¼Œè€Œæ˜¯æ ¹æ®æ—¶é—´çš„æ¨ç§»é€æ¸åœ°ç§»é™¤çª—å£ä¸­çš„æ—§è¯·æ±‚ï¼Œæ·»åŠ æ–°çš„è¯·æ±‚ã€‚
> ä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾æ—¶é—´çª—å£ä¸º10sï¼Œè¯·æ±‚é™åˆ¶ä¸º3ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚åœ¨10:00:00å‘èµ·ï¼Œç¬¬äºŒæ¬¡åœ¨10:00:05å‘èµ·ï¼Œç¬¬ä¸‰æ¬¡10:00:11å‘èµ·ï¼Œé‚£ä¹ˆè®¡æ•°å™¨ç­–ç•¥çš„ä¸‹ä¸€ä¸ªçª—å£å¼€å§‹æ—¶é—´æ˜¯10:00:11ï¼Œè€Œæ»‘åŠ¨çª—å£æ˜¯10:00:05ã€‚æ‰€ä»¥è¿™ä¹Ÿæ˜¯æ»‘åŠ¨çª—å£ä¸ºä»€ä¹ˆå¯ä»¥å‡å°‘ä¸´ç•Œé—®é¢˜çš„å½±å“ï¼Œä½†å¹¶ä¸èƒ½å®Œå…¨æ¶ˆé™¤å®ƒçš„åŸå› ã€‚


å¦‚æœå¤§å®¶æƒ³è¯¦ç»†äº†è§£ä¸€äº›å¸¸ç”¨çš„é™æµç®—æ³•ï¼Œå¯ä»¥çœ‹æˆ‘è¿™ç¯‡æ–‡ç« ï¼š[ã€Šä¼˜åŒ–æ¥å£è®¾è®¡çš„æ€è·¯ã€‹ç³»åˆ—ï¼šç¬¬ä¸ƒç¯‡â€”æ¥å£é™æµç­–ç•¥](https://github.com)ã€‚


## 3ã€ä»£ç å®ç°


#### SlidingWindowRateLimit.java



```
package com.summo.demo.config.limitstrategy.slidingwindow;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface SlidingWindowRateLimit {
    /**
     * è¯·æ±‚çš„æ•°é‡
     *
     * @return
     */
    int requests();

    /**
     * æ—¶é—´çª—å£ï¼Œå•ä½ä¸ºç§’
     *
     * @return
     */
    int timeWindow();
}

```

#### SlidingWindowRateLimitAspect.java



```
package com.summo.sbmy.common.limit.slidingwindow;

import com.summo.sbmy.common.util.HttpContextUtil;
import com.summo.sbmy.common.util.IpUtil;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

import java.lang.reflect.Method;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.concurrent.TimeUnit;

@Slf4j
@Aspect
@Component
@Order(5)
public class SlidingWindowRateLimitAspect {
    /**
     * ä½¿ç”¨ ConcurrentHashMap ä¿å­˜æ¯ä¸ªæ–¹æ³•çš„è¯·æ±‚æ—¶é—´æˆ³é˜Ÿåˆ—
     */
    private final ConcurrentHashMap>> METHOD_IP_REQUEST_TIMES_MAP = new ConcurrentHashMap<>();

    @Around("@annotation(com.summo.sbmy.common.limit.slidingwindow.SlidingWindowRateLimit)")
    public Object rateLimit(ProceedingJoinPoint joinPoint) throws Throwable {
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();
        // è·å–å®¢æˆ·ç«¯IPåœ°å€
        String clientIp = IpUtil.getIpAddr(HttpContextUtil.getHttpServletRequest());


        SlidingWindowRateLimit rateLimit = method.getAnnotation(SlidingWindowRateLimit.class);
        // å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°
        int requests = rateLimit.requests();
        // æ»‘åŠ¨çª—å£çš„å¤§å°(ç§’)
        int timeWindow = rateLimit.timeWindow();

        // è·å–æ–¹æ³•åç§°å­—ç¬¦ä¸²
        String methodName = method.toString();
        // å¦‚æœä¸å­˜åœ¨å½“å‰æ–¹æ³•å’ŒIPçš„è¯·æ±‚æ—¶é—´æˆ³é˜Ÿåˆ—ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„é˜Ÿåˆ—
        ConcurrentHashMap> ipRequestTimesMap = METHOD_IP_REQUEST_TIMES_MAP.computeIfAbsent(methodName, k -> new ConcurrentHashMap<>());
        ConcurrentLinkedQueue requestTimes = ipRequestTimesMap.computeIfAbsent(clientIp, k -> new ConcurrentLinkedQueue<>());

        // å½“å‰æ—¶é—´
        long currentTime = System.currentTimeMillis();
        // è®¡ç®—æ—¶é—´çª—å£çš„å¼€å§‹æ—¶é—´æˆ³
        long thresholdTime = currentTime - TimeUnit.SECONDS.toMillis(timeWindow);

        // è¿™ä¸€æ®µä»£ç æ˜¯æ»‘åŠ¨çª—å£é™æµç®—æ³•ä¸­çš„å…³é”®éƒ¨åˆ†ï¼Œå…¶åŠŸèƒ½æ˜¯ç§»é™¤å½“å‰æ»‘åŠ¨çª—å£ä¹‹å‰çš„è¯·æ±‚æ—¶é—´æˆ³ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿çª—å£å†…åªä¿ç•™æœ€è¿‘æ—¶é—´æ®µå†…çš„è¯·æ±‚è®°å½•ã€‚
        // requestTimes.isEmpty() æ˜¯æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºçš„æ¡ä»¶ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ„å‘³ç€æ²¡æœ‰ä»»ä½•è¯·æ±‚è®°å½•ï¼Œä¸éœ€è¦è¿›è¡Œç§»é™¤æ“ä½œã€‚
        // requestTimes.peek() < thresholdTime æ˜¯æ£€æŸ¥é˜Ÿåˆ—å¤´éƒ¨çš„æ—¶é—´æˆ³æ˜¯å¦æ—©äºæ»‘åŠ¨çª—å£çš„å¼€å§‹æ—¶é—´ã€‚å¦‚æœæ˜¯ï¼Œè¯´æ˜è¿™ä¸ªæ—¶é—´æˆ³å·²ç»ä¸åœ¨å½“å‰çš„æ—¶é—´çª—å£å†…ï¼Œåº”å½“è¢«ç§»é™¤ã€‚
        while (!requestTimes.isEmpty() && requestTimes.peek() < thresholdTime) {
            // ç§»é™¤é˜Ÿåˆ—å¤´éƒ¨çš„è¿‡æœŸæ—¶é—´æˆ³
            requestTimes.poll();
        }

        // æ£€æŸ¥å½“å‰æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ¬¡æ•°æ˜¯å¦è¶…è¿‡é™åˆ¶
        if (requestTimes.size() < requests) {
            // æœªè¶…è¿‡é™åˆ¶ï¼Œè®°å½•å½“å‰è¯·æ±‚æ—¶é—´
            requestTimes.add(currentTime);
            return joinPoint.proceed();
        } else {
            // è¶…è¿‡é™åˆ¶ï¼ŒæŠ›å‡ºé™æµå¼‚å¸¸
            throw new RuntimeException("Too many requests, please try again later.");
        }
    }
}

```

#### ä½¿ç”¨æ–¹å¼



```

@Controller
public class IndexController {
    @GetMapping("/")
    @VisitLog
    @SlidingWindowRateLimit(requests = 2, timeWindow = 2)
    public String index(HttpServletRequest request) {
        if (isFromMobile(request)) {
            return "mp/index";
        } else {
            return "web/index";
        }
    }
}

```

# äº”ã€å°ç»“ä¸€ä¸‹


ä¸Šé¢çš„é™æµä½¿ç”¨çš„æ˜¯ConcurrentHashMapæ¥å­˜å‚¨æ¯ä¸ªæ–¹æ³•çš„è¯·æ±‚æ—¶é—´æˆ³é˜Ÿåˆ—ï¼Œé€‚ç”¨äºå•æœºï¼Œå¦‚æœæ˜¯åˆ†å¸ƒå¼çš„ç¯å¢ƒåˆ™å¯ä»¥æ¢æˆRedisã€‚é€šè¿‡åœ¨èµ„æºæ¥å£ä¸ŠåŠ ä¸€ä¸ªé™æµçš„æ–¹å¼æˆ‘ä»¬å¯ä»¥é˜²æ­¢å•ä¸ªIPåˆ·çˆ†æˆ‘ä»¬çš„indexæ¥å£ï¼Œé˜²æ­¢å¸¦å®½æ‰“æ»¡ï¼Œæˆ‘è¯•äº†ä¸‹åº”è¯¥æ˜¯ç”¨çš„ï¼Œå°±æ˜¯ä¸çŸ¥é“å®æˆ˜å¦‚ä½•ã€‚


ä½œè€…ï¼š[ä¸è‹¥ä¸ºæ­¢](https://github.com)æ¬¢è¿ä»»ä½•å½¢å¼çš„è½¬è½½ï¼Œä½†è¯·åŠ¡å¿…æ³¨æ˜å‡ºå¤„ã€‚é™äºæœ¬äººæ°´å¹³ï¼Œå¦‚æœæ–‡ç« å’Œä»£ç æœ‰è¡¨è¿°ä¸å½“ä¹‹å¤„ï¼Œè¿˜è¯·ä¸åèµæ•™ã€‚

